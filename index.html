<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hot Potato Trivia Game</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: url('background.png') no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #fff;
  }
  h1 {
    color: #ffd700;
    text-shadow: 2px 2px #8b0000;
  }
  button {
    background: #ff4500;
    border: none;
    padding: 10px 15px;
    margin: 5px;
    cursor: pointer;
    color: #fff;
    border-radius: 8px;
    font-size: 14px;
  }
  button:hover {
    background: #cc0000;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #gameArea, #startGame, #leaveGame {
    display: none;
  }
  #playerList {
    margin: 10px 0;
    width: 200px;
  }
  .player {
    padding: 8px 12px;
    background: #ff6347;
    border: 1px solid #ffd700;
    border-radius: 6px;
    margin: 3px;
    display: flex;
    justify-content: space-between;
    color: #fff;
  }
  .player.host {
    border: 2px solid #ffd700;
    font-weight: bold;
  }
  .player.out {
    opacity: 0.5;
    text-decoration: line-through;
  }
  #lyricDisplay {
    font-size: 24px;
    font-weight: bold;
    margin: 20px 0;
    color: #ffd700;
  }
  #potatoStatus {
    margin-bottom: 10px;
    color: #fff;
  }
  #statusBar {
    margin-top: 15px;
    color: #ffd700;
    min-height: 18px;
  }
  #playerDiagram {
    position: relative;
    width: 400px;
    height: 400px;
    margin: 20px auto;
  }
  #hotPotatoImage {
    max-width: 200px;
    margin-bottom: 20px;
  }
  #triviaModal {
    display: none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 400px;
    background: transparent;
    justify-content: center;
    align-items: flex-start;
    z-index: 1000;
  }
  #triviaContent {
    background: rgba(255, 69, 0, 0.9);
    padding: 15px;
    border-radius: 10px;
    width: 100%;
    text-align: center;
    color: #fff;
    border: 2px solid #ffd700;
  }
  #triviaQuestion {
    font-size: 16px;
    margin-bottom: 15px;
  }
  .answerBtn {
    display: block;
    width: 80%;
    margin: 8px auto;
    background: #ff6347;
    padding: 8px;
    font-size: 14px;
  }
  .answerBtn:hover {
    background: #cc0000;
  }
  .answerBtn:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #triviaFeedback {
    margin-top: 10px;
    font-weight: bold;
    font-size: 14px;
  }
  #triviaTimer {
    margin-bottom: 10px;
    font-weight: bold;
    font-size: 14px;
    color: #ffd700;
  }
</style>
</head>
<body>

<img id="hotPotatoImage" src="https://png.pngtree.com/png-vector/20220917/ourmid/pngtree-hot-potato-saying-cartoon-dangerous-proverb-drawing-vector-png-image_14545442.png" alt="Hot Potato" />
<h1>Hot Potato Trivia Game</h1>
<p id="currentRoom">Current Room: <span id="roomDisplay"></span></p>

<div id="lobbyArea">
  <input type="text" id="username" placeholder="Enter your name" />
  <button id="joinGame">Join Game</button>
  <button id="leaveGame">Leave Game</button>
  <div id="playerList"></div>
  <button id="startGame">Start Game</button>
</div>

<div id="gameArea">
  <div id="potatoStatus">Waiting for game to start...</div>
  <div id="lyricDisplay"></div>
  <div id="playerDiagram"></div>
</div>

<div id="triviaModal">
  <div id="triviaContent">
    <div id="triviaTimer"></div>
    <div id="triviaQuestion"></div>
    <div id="triviaAnswers"></div>
    <div id="triviaFeedback"></div>
  </div>
</div>

<div id="statusBar"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, runTransaction,
  collection, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB2_jo_IniRf7IYXmdziTN4yezDxjZxTD0",
  authDomain: "hotpotatoe-12db7.firebaseapp.com",
  projectId: "hotpotatoe-12db7",
  storageBucket: "hotpotatoe-12db7.firebasestorage.app",
  messagingSenderId: "495938423140",
  appId: "1:495938423140:web:ee57563ed78bbe5f41d271",
  measurementId: "G-TRN809H4JK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const lyrics = [
  "hot", "potato", "hot", "potato", "hot", "potato", "hot", "potato",
  "if", "you", "have", "the", "Potato", "you", "are", "out!"
];
const outIndex = lyrics.indexOf("out!");
const MAX_PLAYERS = 8;

let gameId = localStorage.getItem('gameId') || null;
let playerId = localStorage.getItem('playerId') || null;
let playerName = localStorage.getItem('playerName') || "";
let potatoHolder = null;
let prevPotatoHolder = null;
let lyricIndex = 0;
let isHost = false;
let joined = false;
let gameUnsub = null;
let lyricTimer = null;
let triviaQuestion = null;
let triviaTimer = null;
let questionTimer = null;

const usernameInput = document.getElementById("username");
const joinBtn = document.getElementById("joinGame");
const leaveBtn = document.getElementById("leaveGame");
const startBtn = document.getElementById("startGame");
const playerListEl = document.getElementById("playerList");
const gameArea = document.getElementById("gameArea");
const potatoStatus = document.getElementById("potatoStatus");
const lyricDisplay = document.getElementById("lyricDisplay");
const statusBar = document.getElementById("statusBar");
const lobbyArea = document.getElementById("lobbyArea");
const roomDisplay = document.getElementById("roomDisplay");
const triviaModal = document.getElementById("triviaModal");
const triviaQuestionEl = document.getElementById("triviaQuestion");
const triviaAnswersEl = document.getElementById("triviaAnswers");
const triviaFeedbackEl = document.getElementById("triviaFeedback");
const triviaTimerEl = document.getElementById("triviaTimer");

if(playerId && playerName && gameId) {
  usernameInput.value = playerName;
  joined = true;
  joinBtn.style.display = "none";
  leaveBtn.style.display = "inline-block";
  roomDisplay.textContent = gameId;
  listenForGameUpdates();
} else {
  gameId = null;
}

function setStatus(text) {
  statusBar.textContent = text;
}

function closeTriviaModal() {
  triviaModal.style.display = "none";
  triviaQuestionEl.textContent = "";
  triviaAnswersEl.innerHTML = "";
  triviaFeedbackEl.textContent = "";
  triviaTimerEl.textContent = "";
  if(triviaTimer) {
    clearTimeout(triviaTimer);
    triviaTimer = null;
  }
  if(questionTimer) {
    clearInterval(questionTimer);
    questionTimer = null;
  }
}

async function fetchTriviaQuestion(attempt = 1, maxAttempts = 3) {
  try {
    const response = await fetch('https://opentdb.com/api.php?amount=1&type=multiple');
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    const data = await response.json();
    if (data.response_code === 0 && data.results.length > 0) {
      const question = data.results[0];
      const decodeHTML = (str) => {
        const textarea = document.createElement("textarea");
        textarea.innerHTML = str;
        return textarea.value;
      };
      triviaQuestion = {
        question: decodeHTML(question.question),
        correctAnswer: decodeHTML(question.correct_answer),
        incorrectAnswers: question.incorrect_answers.map(decodeHTML),
      };
      return triviaQuestion;
    } else {
      throw new Error("Invalid API response");
    }
  } catch (e) {
    console.error(`Error fetching trivia question (attempt ${attempt}):`, e);
    if (attempt < maxAttempts) {
      setStatus(`Retrying trivia fetch (${attempt}/${maxAttempts})...`);
      return fetchTriviaQuestion(attempt + 1, maxAttempts);
    }
    setStatus("Failed to fetch trivia question. Using fallback.");
    return {
      question: "What is the capital city of France?",
      correctAnswer: "Paris",
      incorrectAnswers: ["London", "Berlin", "Madrid"]
    };
  }
}

async function showTriviaModal() {
  closeTriviaModal();
  const questionData = await fetchTriviaQuestion();
  if (!questionData) return;

  triviaQuestionEl.textContent = questionData.question;
  const allAnswers = [...questionData.incorrectAnswers, questionData.correctAnswer];
  allAnswers.sort(() => Math.random() - 0.5);
  triviaAnswersEl.innerHTML = "";
  allAnswers.forEach(answer => {
    const btn = document.createElement("button");
    btn.className = "answerBtn";
    btn.textContent = answer;
    btn.disabled = false; // Ensure buttons are enabled for new question
    btn.onclick = () => handleTriviaAnswer(answer, questionData.correctAnswer);
    triviaAnswersEl.appendChild(btn);
  });

  // Start 5-second timer
  let timeLeft = 5;
  triviaTimerEl.textContent = `Time left: ${timeLeft}s`;
  questionTimer = setInterval(() => {
    timeLeft -= 1;
    triviaTimerEl.textContent = `Time left: ${timeLeft}s`;
    if (timeLeft <= 0) {
      clearInterval(questionTimer);
      questionTimer = null;
      triviaFeedbackEl.textContent = "Time's up, moving on...";
      const buttons = triviaAnswersEl.querySelectorAll(".answerBtn");
      buttons.forEach(btn => btn.disabled = true);
      triviaTimer = setTimeout(async () => {
        await showTriviaModal();
      }, 3000);
    }
  }, 1000);

  triviaModal.style.display = "flex";
}

async function handleTriviaAnswer(selectedAnswer, correctAnswer) {
  // Clear question timer on any answer
  if (questionTimer) {
    clearInterval(questionTimer);
    questionTimer = null;
  }

  if (selectedAnswer === correctAnswer) {
    triviaFeedbackEl.textContent = "Correct!";
    const gameRef = doc(db, "games", gameId);
    try {
      await runTransaction(db, async (transaction) => {
        const snap = await transaction.get(gameRef);
        if (!snap.exists()) {
          throw new Error("Game document does not exist");
        }
        const game = snap.data();
        const alivePlayers = game.players && Array.isArray(game.players)
          ? game.players.filter(p => p.alive && p.id !== playerId)
          : [];
        if (alivePlayers.length === 0) {
          setStatus("No other players available!");
          return;
        }
        const newHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
        console.log("Passing potato to:", newHolder);
        transaction.update(gameRef, {
          potatoHolder: newHolder
        });
      });
      closeTriviaModal();
    } catch (e) {
      console.error("Transaction failed:", e);
      setStatus("Error passing potato. Please try again.");
    }
  } else {
    triviaFeedbackEl.textContent = "Incorrect, moving on...";
    const buttons = triviaAnswersEl.querySelectorAll(".answerBtn");
    buttons.forEach(btn => btn.disabled = true);
    triviaTimer = setTimeout(async () => {
      await showTriviaModal();
    }, 3000);
  }
}

joinBtn.addEventListener("click", async () => {
  if(joined) return;
  playerName = usernameInput.value.trim();
  if(!playerName) {
    alert("Please enter your name!");
    return;
  }
  if(playerId) {
    alert("You have already joined the game on this device.");
    return;
  }

  playerId = `${Date.now()}-${Math.floor(Math.random() * 1000)}`;
  let targetGameId = 'main-room';
  let gameRef = doc(db, "games", targetGameId);
  let snap = await getDoc(gameRef);

  // Check if main-room is full or playing
  if (snap.exists()) {
    const gameData = snap.data();
    const playerCount = gameData.players && Array.isArray(gameData.players) ? gameData.players.length : 0;
    if (playerCount >= MAX_PLAYERS || gameData.state === "playing") {
      setStatus("Main room is full or in progress. Trying game-2...");
      targetGameId = 'game-2';
      gameRef = doc(db, "games", targetGameId);
      snap = await getDoc(gameRef);

      // Check if game-2 is full or playing
      if (snap.exists()) {
        const game2Data = snap.data();
        const game2PlayerCount = game2Data.players && Array.isArray(game2Data.players) ? game2Data.players.length : 0;
        if (game2PlayerCount >= MAX_PLAYERS || game2Data.state === "playing") {
          setStatus("Game-2 is full or in progress. Creating new lobby...");
          targetGameId = `room-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
          gameRef = doc(db, "games", targetGameId);
          snap = await getDoc(gameRef);
        } else {
          setStatus(`Joining game-2...`);
        }
      } else {
        setStatus(`Game-2 does not exist. Creating game-2...`);
      }
    } else {
      setStatus(`Joining main-room...`);
    }
  }

  try {
    if (!snap.exists()) {
      await setDoc(gameRef, {
        players: [],
        state: "lobby",
        host: playerId,
        potatoHolder: null,
        lyricIndex: 0
      });
      isHost = true;
    } else {
      const gameData = snap.data();
      isHost = (gameData.host === playerId);
    }
    await updateDoc(gameRef, {
      players: arrayUnion({ id: playerId, name: playerName, alive: true })
    });
    localStorage.setItem('playerId', playerId);
    localStorage.setItem('playerName', playerName);
    localStorage.setItem('gameId', targetGameId);
    gameId = targetGameId;
    roomDisplay.textContent = gameId;
    joined = true;
    joinBtn.style.display = "none";
    leaveBtn.style.display = "inline-block";
    listenForGameUpdates();
    setStatus("Joined game lobby.");
  } catch (err) {
    console.error(err);
    setStatus("Error joining game.");
  }
});

leaveBtn.addEventListener("click", async () => {
  if(!joined) return;
  await leaveGame();
});

startBtn.addEventListener("click", async () => {
  if (!joined) return;
  if (!isHost) {
    alert("Only the host can start the game.");
    return;
  }
  const gameRef = doc(db, "games", gameId);
  const snap = await getDoc(gameRef);
  if (!snap.exists()) return;
  const game = snap.data();
  const alivePlayers = game.players && Array.isArray(game.players)
    ? game.players.filter(p => p.alive)
    : [];
  if (alivePlayers.length < 2) {
    alert("Need at least 2 players to start.");
    return;
  }
  const randomHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
  await updateDoc(gameRef, {
    state: "playing",
    potatoHolder: randomHolder,
    lyricIndex: 0
  });
  lyricIndex = 0;
  setStatus("Game started!");
});

function listenForGameUpdates() {
  if (!gameId) return;
  const gameRef = doc(db, "games", gameId);

  if(gameUnsub) gameUnsub();

  gameUnsub = onSnapshot(gameRef, async (snap) => {
    if (!snap.exists()) {
      setStatus("Game room does not exist.");
      await leaveGame();
      return;
    }
    const game = snap.data();

    // If no valid host or host is not alive, assign first alive player as host
    if (!game.host || !(game.players && Array.isArray(game.players) && game.players.some(p => p.id === game.host && p.alive))) {
      const firstAlive = game.players && Array.isArray(game.players)
        ? game.players.find(p => p.alive)
        : null;
      if (firstAlive) {
        try {
          await updateDoc(gameRef, { host: firstAlive.id });
          if(firstAlive.id === playerId) isHost = true;
        } catch (e) {
          console.error(e);
        }
      }
    } else {
      isHost = (game.host === playerId);
    }

    renderPlayers(game.players || [], game.host);

    if (game.state === "lobby") {
      setStartButton(isHost && (game.players || []).filter(p => p.alive).length >= 2 && (game.players || []).length <= MAX_PLAYERS);
      gameArea.style.display = "none";
      lobbyArea.style.display = "block";
      potatoStatus.textContent = "Waiting for game to start...";
      lyricDisplay.textContent = "";
      closeTriviaModal();
      if(lyricTimer) {
        clearInterval(lyricTimer);
        lyricTimer = null;
      }
    } else if (game.state === "playing") {
      lobbyArea.style.display = "none";
      gameArea.style.display = "block";
      potatoHolder = game.potatoHolder;
      lyricIndex = game.lyricIndex || 0;

      lyricDisplay.textContent = lyrics[lyricIndex] || "";

      if (potatoHolder === playerId) {
        if (prevPotatoHolder !== potatoHolder) {
          showTriviaModal();
        }
        potatoStatus.textContent = "You have the potato! Answer the trivia question.";
      } else {
        const holderName = (game.players && game.players.find(p => p.id === potatoHolder) || {}).name || "Someone";
        potatoStatus.textContent = `${holderName} has the potato`;
        closeTriviaModal();
      }
      prevPotatoHolder = potatoHolder;

      renderDiagram(game.players || [], game.potatoHolder);

      const me = game.players && game.players.find(p => p.id === playerId);
      if (!me || !me.alive) {
        alert("You are out!");
        closeTriviaModal();
        await leaveGame();
      }

      if (isHost && !lyricTimer) {
        lyricTimer = setInterval(async () => {
          try {
            await runTransaction(db, async (transaction) => {
              const snap = await transaction.get(gameRef);
              if (!snap.exists()) return;
              const game = snap.data();
              if (game.state !== "playing") return;

              let newIndex = (game.lyricIndex + 1) % lyrics.length;
              let updates = { lyricIndex: newIndex };

              if (newIndex === outIndex) {
                const playersUpdated = game.players && Array.isArray(game.players)
                  ? game.players.map(p => p.id === game.potatoHolder ? { ...p, alive: false } : p)
                  : [];
                updates.players = playersUpdated;
                const alivePlayers = playersUpdated.filter(p => p.alive);
                if (alivePlayers.length <= 1) {
                  updates.state = "ended";
                } else {
                  updates.potatoHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
                  updates.lyricIndex = 0;
                }
              }

              transaction.update(gameRef, updates);
            });
          } catch (e) {
            console.error("Lyric transaction failed:", e);
          }
        }, 2000);
      }
    } else if (game.state === "ended") {
      const me = game.players && game.players.find(p => p.id === playerId);
      if (me && me.alive) {
        alert("You win!");
      } else {
        alert("Game over");
      }
      if (isHost) {
        try {
          await updateDoc(gameRef, {
            players: [],
            state: "lobby",
            host: null,
            potatoHolder: null,
            lyricIndex: 0
          });
          setStatus("Game room reset for new game.");
        } catch (e) {
          console.error("Failed to reset game room:", e);
          setStatus("Error resetting game room.");
        }
      }
      gameArea.style.display = "none";
      lobbyArea.style.display = "block";
      potatoStatus.textContent = "Waiting for game to start...";
      lyricDisplay.textContent = "";
      closeTriviaModal();
      if (lyricTimer) {
        clearInterval(lyricTimer);
        lyricTimer = null;
      }
    }
    roomDisplay.textContent = gameId;
  });
}

function renderPlayers(players, hostId) {
  playerListEl.innerHTML = "";
  players.forEach(p => {
    const div = document.createElement("div");
    div.className = "player";
    if (p.id === hostId) div.classList.add("host");
    if (!p.alive) div.classList.add("out");
    div.textContent = p.name + (p.alive ? "" : " (out)");

    if (p.id === playerId && joined) {
      const leaveBtn = document.createElement("button");
      leaveBtn.textContent = "Leave";
      leaveBtn.style.marginLeft = "8px";
      leaveBtn.onclick = async () => {
        await leaveGame();
      };
      div.appendChild(leaveBtn);
    }

    playerListEl.appendChild(div);
  });
  setStartButton(isHost && players.filter(p => p.alive).length >= 2 && players.length <= MAX_PLAYERS);
}

function renderDiagram(players, holder) {
  const diagramEl = document.getElementById("playerDiagram");
  diagramEl.innerHTML = "";
  diagramEl.style.position = "relative";
  diagramEl.style.width = "400px";
  diagramEl.style.height = "400px";

  const num = players.length;
  players.forEach((p, i) => {
    const icon = document.createElement("div");
    icon.style.position = "absolute";
    const angle = 2 * Math.PI * i / num;
    icon.style.left = `${200 + 150 * Math.cos(angle)}px`;
    icon.style.top = `${200 + 150 * Math.sin(angle)}px`;
    icon.style.transform = "translate(-50%, -50%)";
    icon.style.textAlign = "center";
    if (!p.alive) icon.style.opacity = "0.5";

    const nameSpan = document.createElement("div");
    nameSpan.textContent = p.name;
    nameSpan.style.fontSize = "12px";
    nameSpan.style.color = "#ffd700";
    icon.appendChild(nameSpan);

    const avatar = document.createElement("div");
    avatar.textContent = p.alive ? "🧑" : "💀";
    if (p.id === holder && p.alive) avatar.textContent += "🥔";
    avatar.style.fontSize = "30px";
    icon.appendChild(avatar);

    diagramEl.appendChild(icon);
  });
}

async function leaveGame() {
  if (!playerId || !gameId) return;
  const gameRef = doc(db, "games", gameId);
  try {
    const snap = await getDoc(gameRef);
    if (snap.exists()) {
      const game = snap.data();
      if (game.players && Array.isArray(game.players)) {
        const newPlayers = game.players.filter(p => p.id !== playerId);
        await updateDoc(gameRef, { players: newPlayers });
        if (game.host === playerId && newPlayers.length > 0) {
          await updateDoc(gameRef, { host: newPlayers[0].id });
        }
      }
    }
  } catch (e) {
    console.error("Error in leaveGame:", e);
  }
  localStorage.removeItem('playerId');
  localStorage.removeItem('playerName');
  // Keep gameId to allow rejoining the same room
  playerId = null;
  playerName = "";
  joined = false;
  joinBtn.style.display = "inline-block";
  leaveBtn.style.display = "none";
  setStartButton(false);
  gameArea.style.display = "none";
  lobbyArea.style.display = "block";
  potatoStatus.textContent = "Waiting for game to start...";
  lyricDisplay.textContent = "";
  setStatus("");
  closeTriviaModal();
  if (lyricTimer) {
    clearInterval(lyricTimer);
    lyricTimer = null;
  }
  roomDisplay.textContent = gameId;
}

window.addEventListener('beforeunload', async () => {
  // Don't auto-remove player on reload — keep them in the game
});

function setStartButton(enabled) {
  startBtn.disabled = !enabled;
  startBtn.style.display = isHost ? "inline-block" : "none";
}

</script>

</body>
</html>
