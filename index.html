<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hot Potato Game</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #ffe6f0;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    color: #ff4da6;
  }
  button {
    background-color: #ff80bf;
    border: none;
    padding: 10px 15px;
    margin: 5px;
    cursor: pointer;
    color: white;
    border-radius: 8px;
    font-size: 14px;
  }
  button:hover {
    background-color: #ff4da6;
  }
  #gameArea {
    display: none;
    margin-top: 20px;
  }
  .player {
    padding: 8px 12px;
    background-color: #fff0f5;
    border: 1px solid #ffb3d9;
    border-radius: 6px;
    margin: 5px;
  }
  .player.host {
    border: 2px solid gold;
  }
  .player.ready {
    background-color: #d4f8d4;
  }
</style>
</head>
<body>

<h1>Hot Potato Game</h1>

<div id="lobbyArea">
  <input type="text" id="username" placeholder="Enter your name" />
  <button id="joinGame">Join Game</button>
  <div id="playerList"></div>
  <button id="startGame" style="display:none;">Start Game</button>
</div>

<div id="gameArea">
  <h2 id="potatoStatus">Waiting...</h2>
  <div>Clicks: <span id="clicksCount">0</span></div>
  <div>Hold Timer: <span id="holdTimer">0</span> seconds</div>
  <button id="passPotato">Pass Potato</button>
  <div id="lyricDisplay"></div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, runTransaction, arrayRemove
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB2_jo_IniRf7IYXmdziTN4yezDxjZxTD0",
  authDomain: "hotpotatoe-12db7.firebaseapp.com",
  projectId: "hotpotatoe-12db7",
  storageBucket: "hotpotatoe-12db7.firebasestorage.app",
  messagingSenderId: "495938423140",
  appId: "1:495938423140:web:ee57563ed78bbe5f41d271",
  measurementId: "G-TRN809H4JK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let playerId = null;
let playerName = "";
const gameId = "main-room";
let potatoHolder = null;
const lyrics = ["hot", "potato", "hot", "potato", "hot", "potato", "hot", "potato", "if", "you", "have", "the", "Potato", "you", "are", "out!"];
let lyricIndex = 0;

// Intervals declared once at top
let lyricInterval = null;
let holdTimerInterval = null;
let holdSeconds = 0;

// Elements
const usernameInput = document.getElementById("username");
const joinBtn = document.getElementById("joinGame");
const startBtn = document.getElementById("startGame");
const playerListEl = document.getElementById("playerList");
const gameArea = document.getElementById("gameArea");
const potatoStatus = document.getElementById("potatoStatus");
const passBtn = document.getElementById("passPotato");
const lyricDisplay = document.getElementById("lyricDisplay");
const clicksCount = document.getElementById("clicksCount");
const holdTimerDisplay = document.getElementById("holdTimer");

let canJoin = true; // to prevent join spam

joinBtn.addEventListener("click", async () => {
  if (!canJoin) return;
  canJoin = false;
  joinBtn.disabled = true;

  playerName = usernameInput.value.trim();
  if (!playerName) {
    alert("Enter your name!");
    canJoin = true;
    joinBtn.disabled = false;
    return;
  }

  playerId = `${Date.now()}-${Math.floor(Math.random() * 1000)}`;
  const gameRef = doc(db, "games", gameId);
  const snap = await getDoc(gameRef);
  if (!snap.exists()) {
    await setDoc(gameRef, {
      players: [],
      state: "lobby",
      host: playerId,
      potatoHolder: null,
      lastActive: {}
    });
  }
  
  // Add or update player, and record lastActive timestamp
  await runTransaction(db, async (transaction) => {
    const docSnap = await transaction.get(gameRef);
    const data = docSnap.data();
    const players = data.players || [];
    // Remove offline players who have not pinged in 10s
    const now = Date.now();
    const lastActive = data.lastActive || {};
    const activePlayers = players.filter(p => (now - (lastActive[p.id] || 0)) < 10000);

    // Add or update current player
    if (!activePlayers.find(p => p.id === playerId)) {
      activePlayers.push({ id: playerId, name: playerName, alive: true });
    }

    const updatedLastActive = { ...(lastActive), [playerId]: now };

    transaction.update(gameRef, {
      players: activePlayers,
      lastActive: updatedLastActive
    });

    // If no host, assign this player as host
    if (!data.host || !activePlayers.find(p => p.id === data.host)) {
      transaction.update(gameRef, { host: playerId });
    }
  });

  listenForGameUpdates();
});

function listenForGameUpdates() {
  const gameRef = doc(db, "games", gameId);
  onSnapshot(gameRef, (snap) => {
    if (!snap.exists()) return;
    const game = snap.data();

    renderPlayers(game.players || [], game.host);

    if (game.state === "playing") {
      document.getElementById("lobbyArea").style.display = "none";
      gameArea.style.display = "block";

      potatoHolder = game.potatoHolder;
      lyricIndex = game.lyricIndex || 0;

      potatoStatus.textContent = 
        potatoHolder === playerId ? "You have the potato!" : 
        `${(game.players.find(p => p.id === potatoHolder) || {}).name || "Unknown"} has the potato`;

      clicksCount.textContent = game.clicks?.[playerId] || 0;

      startLyricInterval(gameRef, game);
      startHoldTimer(gameRef);
      
      if (game.host === playerId) {
        startBtn.style.display = "none";
      }
    } else {
      document.getElementById("lobbyArea").style.display = "block";
      gameArea.style.display = "none";
      startBtn.style.display = (game.host === playerId) ? "inline-block" : "none";
    }
  });
}

function renderPlayers(players, hostId) {
  playerListEl.innerHTML = "";
  players.forEach(p => {
    const div = document.createElement("div");
    div.className = "player";
    if (p.id === hostId) div.classList.add("host");
    div.textContent = p.name + (p.alive ? "" : " (out)");
    playerListEl.appendChild(div);
  });
}

// Start game button logic
startBtn.addEventListener("click", async () => {
  const gameRef = doc(db, "games", gameId);
  const snap = await getDoc(gameRef);
  const game = snap.data();
  if (game.host !== playerId) return;

  const alivePlayers = game.players.filter(p => p.alive);
  if (alivePlayers.length < 2) {
    alert("Need at least 2 players alive to start.");
    return;
  }

  const randomHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
  await updateDoc(gameRef, {
    state: "playing",
    potatoHolder: randomHolder,
    lyricIndex: 0,
    clicks: {},
  });
});

// Pass potato button logic
passBtn.addEventListener("click", async () => {
  if (potatoHolder !== playerId) return;

  const gameRef = doc(db, "games", gameId);
  await runTransaction(db, async (transaction) => {
    const snap = await transaction.get(gameRef);
    const game = snap.data();

    // Update clicks for player
    const currentClicks = (game.clicks && game.clicks[playerId]) || 0;
    const newClicks = currentClicks + 1;

    let updatedClicks = { ...game.clicks, [playerId]: newClicks };

    // If clicks reach 5, pass potato
    if (newClicks >= 5) {
      const alivePlayers = game.players.filter(p => p.alive && p.id !== playerId);
      if (alivePlayers.length > 0) {
        const nextHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
        transaction.update(gameRef, {
          potatoHolder: nextHolder,
          clicks: {}
        });
        resetHoldTimer(gameRef);
      } else {
        // No one else alive, keep potato
        updatedClicks = { ...updatedClicks, [playerId]: 0 };
      }
    } else {
      transaction.update(gameRef, { clicks: updatedClicks });
    }
  });
});

function startLyricInterval(gameRef, game) {
  if (lyricInterval) return; // already running

  lyricInterval = setInterval(async () => {
    lyricIndex++;
    if (lyricIndex >= lyrics.length) {
      clearInterval(lyricInterval);
      lyricInterval = null;

      // The last lyric means current potato holder is out
      const snap = await getDoc(gameRef);
      const game = snap.data();

      const holderId = game.potatoHolder;
      if (holderId) {
        const players = game.players.map(p => ({...p}));
        const index = players.findIndex(p => p.id === holderId);
        if (index !== -1) {
          players[index].alive = false;
        }

        // Update players, reset clicks and lyricIndex
        await updateDoc(gameRef, {
          players,
          potatoHolder: null,
          lyricIndex: 0,
          clicks: {}
        });

        // Send out eliminated player home (you can customize UI for that)
        if (holderId === playerId) {
          alert("You are out! Returning to lobby.");
          document.getElementById("lobbyArea").style.display = "block";
          gameArea.style.display = "none";
        }

        // Restart game automatically if more than 1 alive
        const aliveCount = players.filter(p => p.alive).length;
        if (aliveCount > 1) {
          const alivePlayers = players.filter(p => p.alive);
          const newHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
          await updateDoc(gameRef, {
            potatoHolder: newHolder,
            state: "playing",
            lyricIndex: 0,
            clicks: {}
          });
          resetHoldTimer(gameRef);
        } else {
          await updateDoc(gameRef, {
            state: "lobby",
            potatoHolder: null,
            clicks: {},
            lyricIndex: 0
          });
          startBtn.style.display = (game.host === playerId) ? "inline-block" : "none";
        }
      }
      return;
    }

    // Update lyric index
    await updateDoc(gameRef, { lyricIndex });
    lyricDisplay.textContent = lyrics[lyricIndex];
  }, 900);
}

function startHoldTimer(gameRef) {
  if (holdTimerInterval) return;

  holdSeconds = 0;
  holdTimerDisplay.textContent = holdSeconds;

  holdTimerInterval = setInterval(async () => {
    holdSeconds++;
    holdTimerDisplay.textContent = holdSeconds;

    if (holdSeconds >= 5) {
      clearInterval(holdTimerInterval);
      holdTimerInterval = null;

      // Force pass potato if player holding it didn't pass in time
      const snap = await getDoc(gameRef);
      const game = snap.data();
      const holderId = game.potatoHolder;

      if (holderId) {
        const alivePlayers = game.players.filter(p => p.alive && p.id !== holderId);
        if (alivePlayers.length > 0) {
          const nextHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
          await updateDoc(gameRef, {
            potatoHolder: nextHolder,
            clicks: {}
          });
          resetHoldTimer(gameRef);
        }
      }
    }
  }, 1000);
}

function resetHoldTimer(gameRef) {
  clearInterval(holdTimerInterval);
  holdTimerInterval = null;
  holdSeconds = 0;
  holdTimerDisplay.textContent = holdSeconds;
  startHoldTimer(gameRef);
}

</script>

</body>
</html>
