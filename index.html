<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hot Potato Game</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background:#ffe6f0;
    margin:0; padding:20px;
    display:flex; flex-direction:column; align-items:center;
  }
  h1 { color:#ff4da6; }
  button {
    background:#ff80bf; border:none; padding:10px 15px;
    margin:5px; cursor:pointer; color:#fff; border-radius:8px; font-size:14px;
  }
  button:hover { background:#ff4da6; }
  #gameArea, #startGame, #leaveGame { display:none; }
  #playerList { margin:10px 0; width: 200px; }
  .player {
    padding:8px 12px; background:#fff0f5; border:1px solid #ffb3d9;
    border-radius:6px; margin:3px; display:flex; justify-content:space-between;
  }
  .player.host { border:2px solid gold; font-weight:bold; }
  .player.out { opacity:0.5; text-decoration:line-through; }
  #lyricDisplay { font-size:24px; font-weight:bold; margin:20px 0; }
  #potatoStatus { margin-bottom:10px; }
  #clicksDisplay { font-weight:bold; margin-bottom:10px; }
  #potatoTimerDisplay { margin-top:5px; font-size:14px; color:#cc3366; }
  #statusBar { margin-top:15px; color:#990033; min-height:18px; }
</style>
</head>
<body>

<h1>Hot Potato Game</h1>

<div id="lobbyArea">
  <input type="text" id="username" placeholder="Enter your name" />
  <button id="joinGame">Join Game</button>
  <button id="leaveGame">Leave Game</button>
  <div id="playerList"></div>
  <button id="startGame">Start Game</button>
</div>

<div id="gameArea">
  <div id="potatoStatus">Waiting for game to start...</div>
  <div id="clicksDisplay">Your clicks: 0</div>
  <button id="passPotato">Click Potato</button>
  <div id="potatoTimerDisplay"></div>
  <div id="lyricDisplay"></div>
</div>

<div id="statusBar"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, runTransaction
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB2_jo_IniRf7IYXmdziTN4yezDxjZxTD0",
  authDomain: "hotpotatoe-12db7.firebaseapp.com",
  projectId: "hotpotatoe-12db7",
  storageBucket: "hotpotatoe-12db7.firebasestorage.app",
  messagingSenderId: "495938423140",
  appId: "1:495938423140:web:ee57563ed78bbe5f41d271",
  measurementId: "G-TRN809H4JK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const gameId = "main-room";
const lyrics = [
  "hot", "potato", "hot", "potato", "hot", "potato", "hot", "potato",
  "if", "you", "have", "the", "Potato", "you", "are", "out!"
];
const clicksToPass = 5;
const potatoMaxHoldSeconds = 5;

let playerId = localStorage.getItem('playerId') || null;
let playerName = localStorage.getItem('playerName') || "";
let potatoHolder = null;
let lyricIndex = 0;
let playerClicks = 0;
let holdTimer = null;
let holdSecondsLeft = potatoMaxHoldSeconds;
let isHost = false;
let joined = false;
let gameUnsub = null;

const usernameInput = document.getElementById("username");
const joinBtn = document.getElementById("joinGame");
const leaveBtn = document.getElementById("leaveGame");
const startBtn = document.getElementById("startGame");
const playerListEl = document.getElementById("playerList");
const gameArea = document.getElementById("gameArea");
const potatoStatus = document.getElementById("potatoStatus");
const clicksDisplay = document.getElementById("clicksDisplay");
const passBtn = document.getElementById("passPotato");
const potatoTimerDisplay = document.getElementById("potatoTimerDisplay");
const lyricDisplay = document.getElementById("lyricDisplay");
const statusBar = document.getElementById("statusBar");
const lobbyArea = document.getElementById("lobbyArea");

if(playerId && playerName) {
  usernameInput.value = playerName;
  joined = true;
  joinBtn.style.display = "none";
  leaveBtn.style.display = "inline-block";
  listenForGameUpdates();
}

function setStatus(text) {
  statusBar.textContent = text;
}

function resetHoldTimer() {
  if(holdTimer) clearInterval(holdTimer);
  holdSecondsLeft = potatoMaxHoldSeconds;
  updateHoldTimerDisplay();
  holdTimer = setInterval(() => {
    holdSecondsLeft--;
    updateHoldTimerDisplay();
    if(holdSecondsLeft <= 0) {
      passPotatoDueToTimeout();
    }
  }, 1000);
}

function updateHoldTimerDisplay() {
  potatoTimerDisplay.textContent = `Pass potato in: ${holdSecondsLeft}s`;
}

function stopHoldTimer() {
  if(holdTimer) {
    clearInterval(holdTimer);
    holdTimer = null;
    potatoTimerDisplay.textContent = "";
  }
}

joinBtn.addEventListener("click", async () => {
  if(joined) return;
  playerName = usernameInput.value.trim();
  if(!playerName) {
    alert("Please enter your name!");
    return;
  }
  if(playerId) {
    alert("You have already joined the game on this device.");
    return;
  }

  playerId = `${Date.now()}-${Math.floor(Math.random() * 1000)}`;
  try {
    const gameRef = doc(db, "games", gameId);
    const snap = await getDoc(gameRef);
    if (!snap.exists()) {
      await setDoc(gameRef, {
        players: [],
        state: "lobby",
        host: playerId,
        potatoHolder: null,
        lyricIndex: 0
      });
      isHost = true;
    } else {
      const gameData = snap.data();
      isHost = (gameData.host === playerId);
    }
    await updateDoc(gameRef, {
      players: arrayUnion({ id: playerId, name: playerName, alive: true })
    });
    localStorage.setItem('playerId', playerId);
    localStorage.setItem('playerName', playerName);
    joined = true;
    joinBtn.style.display = "none";
    leaveBtn.style.display = "inline-block";
    listenForGameUpdates();
    setStatus("Joined game lobby.");
  } catch (err) {
    console.error(err);
    setStatus("Error joining game.");
  }
});

leaveBtn.addEventListener("click", async () => {
  if(!joined) return;
  await leaveGame();
});

startBtn.addEventListener("click", async () => {
  if (!joined) return;
  if (!isHost) {
    alert("Only the host can start the game.");
    return;
  }
  const gameRef = doc(db, "games", gameId);
  const snap = await getDoc(gameRef);
  if (!snap.exists()) return;
  const game = snap.data();
  const alivePlayers = game.players.filter(p => p.alive);
  if (alivePlayers.length < 2) {
    alert("Need at least 2 players to start.");
    return;
  }
  const randomHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
  await updateDoc(gameRef, {
    state: "playing",
    potatoHolder: randomHolder,
    lyricIndex: 0
  });
  lyricIndex = 0;
  playerClicks = 0;
  setStatus("Game started!");
});

passBtn.addEventListener("click", async () => {
  if (potatoHolder !== playerId) return;
  const gameRef = doc(db, "games", gameId);
  try {
    await runTransaction(db, async (transaction) => {
      const snap = await transaction.get(gameRef);
      if (!snap.exists()) return;
      const game = snap.data();
      const alivePlayers = game.players.filter(p => p.alive && p.id !== playerId);
      if (alivePlayers.length === 0) {
        playerClicks = 0;
        return;
      }
      playerClicks++;
      if (playerClicks >= clicksToPass) {
        const newHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
        transaction.update(gameRef, {
          potatoHolder: newHolder,
          lyricIndex: game.lyricIndex + 1
        });
        playerClicks = 0;
        resetHoldTimer();
      } else {
        transaction.update(gameRef, {
          lyricIndex: game.lyricIndex
        });
      }
    });
  } catch (e) {
    console.error(e);
  }
});

async function passPotatoDueToTimeout() {
  const gameRef = doc(db, "games", gameId);
  try {
    await runTransaction(db, async (transaction) => {
      const snap = await transaction.get(gameRef);
      if (!snap.exists()) return;
      const game = snap.data();
      if (game.potatoHolder !== playerId) return;

      const alivePlayers = game.players.filter(p => p.alive && p.id !== playerId);
      if (alivePlayers.length === 0) return;

      const newHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
      transaction.update(gameRef, {
        potatoHolder: newHolder,
        lyricIndex: game.lyricIndex + 1
      });
    });
    playerClicks = 0;
    resetHoldTimer();
  } catch (e) {
    console.error(e);
  }
}

function listenForGameUpdates() {
  const gameRef = doc(db, "games", gameId);

  if(gameUnsub) gameUnsub();

  gameUnsub = onSnapshot(gameRef, async (snap) => {
    if (!snap.exists()) return;
    const game = snap.data();

    // If no valid host or host is not alive, assign first alive player as host
    if (!game.host || !game.players.some(p => p.id === game.host && p.alive)) {
      const firstAlive = game.players.find(p => p.alive);
      if (firstAlive) {
        try {
          await updateDoc(doc(db, "games", gameId), { host: firstAlive.id });
          if(firstAlive.id === playerId) isHost = true;
        } catch (e) {
          console.error(e);
        }
      }
    } else {
      isHost = (game.host === playerId);
    }

    renderPlayers(game.players, game.host);

    if (game.state === "lobby") {
      setStartButton(isHost && game.players.filter(p => p.alive).length >= 2);
      gameArea.style.display = "none";
      lobbyArea.style.display = "block";
      potatoStatus.textContent = "Waiting for game to start...";
      lyricDisplay.textContent = "";
      clicksDisplay.textContent = "";
      potatoTimerDisplay.textContent = "";
      playerClicks = 0;
      clearInterval(holdTimer);
    }
    else if (game.state === "playing") {
      lobbyArea.style.display = "none";
      gameArea.style.display = "block";
      potatoHolder = game.potatoHolder;
      lyricIndex = game.lyricIndex || 0;

      lyricDisplay.textContent = lyrics[lyricIndex] || "";

      if(potatoHolder === playerId) {
        potatoStatus.textContent = "You have the potato!";
        clicksDisplay.textContent = `Your clicks: ${playerClicks}`;
        resetHoldTimer();
      } else {
        const holderName = (game.players.find(p => p.id === potatoHolder) || {}).name || "Someone";
        potatoStatus.textContent = `${holderName} has the potato`;
        clicksDisplay.textContent = "";
        stopHoldTimer();
      }

      const me = game.players.find(p => p.id === playerId);
      if (!me || !me.alive) {
        setStatus("You are out! Returning to lobby...");
        leaveGame();
      }
    }
  });
}

function renderPlayers(players, hostId) {
  playerListEl.innerHTML = "";
  players.forEach(p => {
    const div = document.createElement("div");
    div.className = "player";
    if (p.id === hostId) div.classList.add("host");
    if (!p.alive) div.classList.add("out");
    div.textContent = p.name + (p.alive ? "" : " (out)");

    // Leave button on each player only if it's you
    if (p.id === playerId && joined) {
      const leaveBtn = document.createElement("button");
      leaveBtn.textContent = "Leave";
      leaveBtn.style.marginLeft = "8px";
      leaveBtn.onclick = async () => {
        await leaveGame();
      };
      div.appendChild(leaveBtn);
    }

    playerListEl.appendChild(div);
  });
}

async function leaveGame() {
  if (!playerId) return;
  const gameRef = doc(db, "games", gameId);
  try {
    const snap = await getDoc(gameRef);
    if (!snap.exists()) return;
    const game = snap.data();
    const newPlayers = game.players.filter(p => p.id !== playerId);
    await updateDoc(gameRef, { players: newPlayers });

    // If host left, assign new host
    if (game.host === playerId && newPlayers.length > 0) {
      await updateDoc(gameRef, { host: newPlayers[0].id });
    }
  } catch (e) {
    console.error(e);
  }
  localStorage.removeItem('playerId');
  localStorage.removeItem('playerName');
  playerId = null;
  playerName = "";
  joined = false;
  joinBtn.style.display = "inline-block";
  leaveBtn.style.display = "none";
  setStartButton(false);
  gameArea.style.display = "none";
  lobbyArea.style.display = "block";
  potatoStatus.textContent = "Waiting for game to start...";
  lyricDisplay.textContent = "";
  clicksDisplay.textContent = "";
  potatoTimerDisplay.textContent = "";
  setStatus("");
  clearInterval(holdTimer);
}

window.addEventListener('beforeunload', async () => {
  // Don't auto-remove player on reload — keep them in the game
  // (Remove player only if Leave button clicked)
});

function setStartButton(enabled) {
  startBtn.disabled = !enabled;
  startBtn.style.display = enabled ? "inline-block" : "none";
}

</script>

</body>
</html>
