<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hot Potato Game</title>
<style>
/* ===== CSS ===== */
body {
  font-family: Arial, sans-serif;
  background-color: #ffe6f0;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}
h1 {
  color: #ff4da6;
  margin-top: 20px;
}
button {
  background-color: #ff80bf;
  border: none;
  padding: 10px 15px;
  margin: 5px;
  cursor: pointer;
  color: white;
  border-radius: 8px;
  font-size: 14px;
}
button:hover {
  background-color: #ff4da6;
}
#gameArea {
  display: none;
  margin-top: 20px;
  text-align: center;
}
.player {
  padding: 8px 12px;
  background-color: #fff0f5;
  border: 1px solid #ffb3d9;
  border-radius: 6px;
  margin: 5px;
  font-weight: bold;
}
.player.host {
  border: 2px solid gold;
}
.player.out {
  background-color: #f8d7da;
  color: #721c24;
  text-decoration: line-through;
}
#lyricDisplay {
  font-size: 28px;
  color: #ff4da6;
  margin: 15px 0;
  min-height: 40px;
}
#potatoStatus {
  font-size: 20px;
  margin: 10px 0;
  color: #e60073;
}
</style>
</head>
<body>
<h1>Hot Potato Game</h1>

<div id="lobbyArea">
  <input type="text" id="username" placeholder="Enter your name" />
  <button id="joinGame">Join Game</button>
  <div id="playerList"></div>
  <button id="startGame" style="display:none;">Start Game</button>
  <div id="statusMessage" style="color:#e60073; margin-top:10px;"></div>
</div>

<div id="gameArea">
  <h2 id="potatoStatus">Waiting...</h2>
  <button id="passPotato">Pass Potato</button>
  <div id="lyricDisplay"></div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, runTransaction
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB2_jo_IniRf7IYXmdziTN4yezDxjZxTD0",
  authDomain: "hotpotatoe-12db7.firebaseapp.com",
  projectId: "hotpotatoe-12db7",
  storageBucket: "hotpotatoe-12db7.firebasestorage.app",
  messagingSenderId: "495938423140",
  appId: "1:495938423140:web:ee57563ed78bbe5f41d271",
  measurementId: "G-TRN809H4JK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== GAME VARIABLES =====
let playerId = null;
let playerName = "";
const gameId = "main-room";
let potatoHolder = null;
let lyricIndex = 0;
const lyrics = ["hot", "potato", "hot", "potato", "hot", "potato", "hot", "potato", "if", "you", "have", "the", "Potato", "you", "are", "out!"];

const usernameInput = document.getElementById("username");
const joinBtn = document.getElementById("joinGame");
const startBtn = document.getElementById("startGame");
const playerListEl = document.getElementById("playerList");
const gameArea = document.getElementById("gameArea");
const potatoStatus = document.getElementById("potatoStatus");
const passBtn = document.getElementById("passPotato");
const lyricDisplay = document.getElementById("lyricDisplay");
const lobbyArea = document.getElementById("lobbyArea");
const statusMessage = document.getElementById("statusMessage");

// ===== JOIN GAME =====
joinBtn.addEventListener("click", async () => {
  playerName = usernameInput.value.trim();
  if (!playerName) {
    alert("Enter your name!");
    return;
  }
  playerId = `${Date.now()}-${Math.floor(Math.random() * 1000)}`;
  const gameRef = doc(db, "games", gameId);
  const snap = await getDoc(gameRef);
  if (!snap.exists()) {
    await setDoc(gameRef, {
      players: [],
      state: "lobby",
      host: playerId,
      potatoHolder: null,
      lyricIndex: 0
    });
  }
  // Add this player if not already added
  await updateDoc(gameRef, {
    players: arrayUnion({ id: playerId, name: playerName, alive: true })
  });

  listenForGameUpdates();
  statusMessage.textContent = "Joined game as " + playerName;
  joinBtn.disabled = true;
  usernameInput.disabled = true;
});

// ===== LISTEN FOR UPDATES =====
function listenForGameUpdates() {
  const gameRef = doc(db, "games", gameId);
  onSnapshot(gameRef, (snap) => {
    if (!snap.exists()) return;
    const game = snap.data();

    renderPlayers(game.players, game.host);
    updateGameState(game);
  });
}

// ===== RENDER PLAYERS =====
function renderPlayers(players, hostId) {
  playerListEl.innerHTML = "";
  players.forEach((p) => {
    const div = document.createElement("div");
    div.className = "player";
    if (p.id === hostId) div.classList.add("host");
    if (!p.alive) div.classList.add("out");
    div.textContent = p.name + (p.alive ? "" : " (out)");
    playerListEl.appendChild(div);
  });
  if (hostId === playerId) startBtn.style.display = "inline-block";
  else startBtn.style.display = "none";
}

// ===== UPDATE GAME STATE =====
function updateGameState(game) {
  potatoHolder = game.potatoHolder;
  lyricIndex = game.lyricIndex ?? 0;

  if (game.state === "playing") {
    lobbyArea.style.display = "none";
    gameArea.style.display = "block";
    updatePotatoStatus(game.players);
    showNextLyric(game.lyricIndex);
  } else {
    lobbyArea.style.display = "block";
    gameArea.style.display = "none";
    potatoStatus.textContent = "Waiting for game to start...";
    lyricDisplay.textContent = "";
  }
}

// ===== UPDATE POTATO STATUS =====
function updatePotatoStatus(players) {
  if (potatoHolder === playerId) {
    potatoStatus.textContent = "You have the potato!";
    passBtn.disabled = false;
  } else {
    const holderName = players.find(p => p.id === potatoHolder)?.name || "Unknown";
    potatoStatus.textContent = `${holderName} has the potato`;
    passBtn.disabled = true;
  }
}

// ===== START GAME =====
startBtn.addEventListener("click", async () => {
  const gameRef = doc(db, "games", gameId);
  const snap = await getDoc(gameRef);
  if (!snap.exists()) return;
  const game = snap.data();

  if (game.host !== playerId) {
    alert("Only the host can start the game.");
    return;
  }
  const alivePlayers = game.players.filter(p => p.alive);
  if (alivePlayers.length < 2) {
    alert("Need at least 2 players to start.");
    return;
  }
  const randomHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;

  await updateDoc(gameRef, {
    state: "playing",
    potatoHolder: randomHolder,
    lyricIndex: 0
  });
});

// ===== PASS POTATO =====
passBtn.addEventListener("click", async () => {
  if (potatoHolder !== playerId) return;

  const gameRef = doc(db, "games", gameId);
  await runTransaction(db, async (transaction) => {
    const snap = await transaction.get(gameRef);
    if (!snap.exists()) throw "Game does not exist";
    const game = snap.data();

    const alivePlayers = game.players.filter(p => p.alive && p.id !== playerId);
    if (alivePlayers.length === 0) return; // no one to pass to

    const nextHolder = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;

    // Advance lyric index
    let nextLyricIndex = (game.lyricIndex + 1) % lyrics.length;

    // If last lyric is "out!" handle elimination logic
    if (lyrics[nextLyricIndex] === "out!") {
      // Eliminate current holder
      const updatedPlayers = game.players.map(p => {
        if (p.id === playerId) {
          return { ...p, alive: false };
        }
        return p;
      });

      // Find alive players after elimination
      const aliveAfterElim = updatedPlayers.filter(p => p.alive);

      if (aliveAfterElim.length <= 1) {
        // Game over: set state to finished and no potato holder
        await transaction.update(gameRef, {
          players: updatedPlayers,
          potatoHolder: null,
          lyricIndex: nextLyricIndex,
          state: "finished"
        });
        alert(aliveAfterElim.length === 1 
          ? `Game over! Winner is ${aliveAfterElim[0].name}` 
          : "Game over! No winner.");
      } else {
        // Pick new potato holder from alive players randomly
        const newHolder = aliveAfterElim[Math.floor(Math.random() * aliveAfterElim.length)].id;

        await transaction.update(gameRef, {
          players: updatedPlayers,
          potatoHolder: newHolder,
          lyricIndex: 0
        });
      }
    } else {
      // Normal pass - update potato holder and lyric index
      await transaction.update(gameRef, {
        potatoHolder: nextHolder,
        lyricIndex: nextLyricIndex
      });
    }
  });
});

// ===== SHOW NEXT LYRIC =====
function showNextLyric(index) {
  const word = lyrics[index] || "";
  lyricDisplay.textContent = word;
}
</script>
</body>
</html>
